<!DOCTYPE html><html><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><meta name="generator" content="Gatsby 5.13.3"/><style data-href="/my-blog/styles.1a303912f7f327089878.css" data-identity="gatsby-global-css">body{margin:0;padding:0}@font-face{font-family:taebaek;font-style:normal;font-weight:400;src:url(/my-blog/static/TAEBAEK-1f07c3ec4f67d3a56954563d9ccf1ed3.ttf) format("truetype")}@font-face{font-family:taebaek-milkyway;font-style:normal;font-weight:400;src:url(/my-blog/static/TAEBAEK-milkyway-be8807805a66e1365e5da8d62a854d67.ttf) format("truetype")}.ContentsTree-module--contentsTree__leaf--8208d{color:#fff;font-family:Consolas,monospace;font-size:2.5vh;font-weight:700;text-decoration:none}.Home-module--home--eeb12,.Home-module--home__main--2a0a1{display:flex;height:100vh;width:100vw}.Home-module--home__main--2a0a1{align-items:center;background-color:#000;background-image:linear-gradient(to top left,#28283c,#000014);flex-direction:column;justify-content:center}.Home-module--home__main__canvas--36a08{height:100vh;padding:2vh;position:fixed;width:100vw}.Home-module--home__main__titleBox--c2d57{align-items:flex-end;display:flex;flex-direction:column;height:90%;justify-content:flex-end;width:90%}.Home-module--home__main__titleBox__title--c4566{align-items:center;display:flex;flex-direction:column;z-index:1}.Home-module--home__main__titleBox__title__text--d1066,.Home-module--home__main__titleBox__title__text__vibration--cebde{color:#fff;font-family:taebaek;font-size:8vh;font-weight:700;padding-bottom:1vh;padding-top:1vh;z-index:1}.Home-module--home__main__titleBox__title__text__vibration--cebde{animation:Home-module--vibration--c3fd7 .1s infinite}@keyframes Home-module--vibration--c3fd7{0%{transform:rotate(1deg)}to{transform:rotate(-1deg)}}.Home-module--home__main__titleBox__title__contentsTree--7db75{height:0;opacity:0;overflow:hidden;transition:height .3s ease,opacity .5s ease-in}.Home-module--home__main__titleBox__title--c4566:hover>.Home-module--home__main__titleBox__title__contentsTree--7db75{height:55vh;opacity:1}.Home-module--home__main__titleBox__subtitle--05d67{color:#fff;font-family:taebaek-milkyway;font-size:5vh;font-weight:700;padding-bottom:2vh;padding-top:2vh;z-index:1}.Home-module--home__main__titleBox__contact--33deb{color:#fff;font-family:Consolas,monospace;font-size:3vh;font-weight:400;padding-top:1vh;text-decoration-line:none;z-index:1}.Home-module--home__main__titleBox__contact--33deb:hover{text-decoration:underline}.Navigator-module--navigator--6deb4{align-items:flex-start;display:flex;flex-direction:column;justify-content:center;padding-left:2vw;padding-top:2vh;position:fixed}.Navigator-module--navigator__title--3580b{color:#fff;font-family:taebaek;font-size:5vh;font-weight:700;padding-bottom:1vh;padding-top:1vh;text-decoration:none}.Post-module--post--83824{display:flex;justify-content:space-between}.Post-module--post__background--9bfff{background-image:linear-gradient(to top left,#28283c,#000014);height:100vh;position:fixed;width:100vw;z-index:-1}.Post-module--post__content--4d366{align-content:center;align-items:center;height:100%;width:100%}.Post-module--post__content__markdown--f2389{margin-left:30%;width:50%}.Post-module--post__content__markdown__title--f6def{color:#fff;font-size:5vh;font-weight:700;padding-bottom:3vh;padding-top:3vh}.Post-module--post__content__markdown__author--c2fcc,.Post-module--post__content__markdown__date--5506d{color:#fff;font-size:2.5vh;text-align:end}.PostList-module--postList--5fcc0{justify-content:space-between;width:100%}.PostList-module--postList__background--0a42f{background-image:linear-gradient(to top left,#28283c,#000014);height:100vh;position:fixed;width:100vw;z-index:-1}.PostList-module--postList__category--af01a{color:#fff;font-size:5vh;font-weight:700;margin-left:30%;padding-bottom:5vh;padding-left:2vw;padding-top:5vh}.PostList-module--postList__content--99772{align-content:center;align-items:center;margin-left:30%;width:50%}.PostList-module--postList__content__post--c72c0{border-bottom-color:#404040;border-bottom-style:solid;color:#d0d0d0;margin-left:1.5vw;padding-bottom:3vh;padding-top:3vh;width:95%}.PostList-module--postList__content__post__title--43639{color:#fff;font-size:2.5vh;font-weight:700;text-decoration:none}.PostList-module--postList__content__post__title--43639:hover{text-decoration:underline}.PostList-module--postList__content__post__excerpt--23e54{font-size:2vh;font-weight:400;line-height:160%;padding-bottom:2vh;padding-top:2vh}.PostList-module--postList__content__post__author--0fbc7,.PostList-module--postList__content__post__date--1f2f3{font-size:2vh;font-weight:400;text-align:end}</style></head><body><div id="___gatsby"><div style="outline:none" tabindex="-1" id="gatsby-focus-wrapper"><div class="Post-module--post--83824"><nav class="Navigator-module--navigator--6deb4"><a href="https://bill0077.github.io/my-blog" class="Navigator-module--navigator__title--3580b">bill0077.log</a><div><div class="ContentsTree-module--contentsTree__leaf--8208d">  │</div><div class="ContentsTree-module--contentsTree__leaf--8208d">  ├── ProblemSolving</div><div><a href="https://bill0077.github.io/my-blog/boj" class="ContentsTree-module--contentsTree__leaf--8208d">  │     └── boj </a></div><div class="ContentsTree-module--contentsTree__leaf--8208d">  │</div><div class="ContentsTree-module--contentsTree__leaf--8208d">  ├── SideProjects</div><div><a href="https://bill0077.github.io/my-blog/myblog-dev-log" class="ContentsTree-module--contentsTree__leaf--8208d">  │     ├── myblog-dev-log</a></div><div><a href="https://bill0077.github.io/my-blog/tadak-dev-log" class="ContentsTree-module--contentsTree__leaf--8208d">  │     └── tadak-dev-log</a></div><div class="ContentsTree-module--contentsTree__leaf--8208d">  │</div><div class="ContentsTree-module--contentsTree__leaf--8208d">  ├── Study</div><div><a href="https://bill0077.github.io/my-blog/devops" class="ContentsTree-module--contentsTree__leaf--8208d">  │     └── devops</a></div><div class="ContentsTree-module--contentsTree__leaf--8208d">  │</div><div><a href="https://bill0077.github.io/my-blog/etc" class="ContentsTree-module--contentsTree__leaf--8208d">  └── etc</a></div></div></nav><div class="Post-module--post__background--9bfff"></div><div class="Post-module--post__content--4d366"><div class="Post-module--post__content__markdown--f2389"><div class="Post-module--post__content__markdown__title--f6def">tadak 개발기 - 3. [Backend] Oracle Cloud free tier에 tadak-server 배포</div><div class="Post-module--post__content__markdown__author--c2fcc">written by bill0077</div><div class="Post-module--post__content__markdown__date--5506d">date: 2024-03-04</div><p style="color:#D0D0D0;font-size:2.5vh;line-height:160%" node="[object Object]">frontend는 github pages에서 호스팅하고 있고, backend는 평생 무료 vm을 2개나 제공해주는 oracle cloud에서 <code style="color:darkcyan">docker</code>를 통해 호스팅하기로 결정했다. 이 글에서는 그 과정에서 해결한 <p style="color:white;display:inline;font-weight:bold" node="[object Object]">여러가지</p> 문제를 다뤄보겠다. 크게 3가지 과정으로 분리해 보았다.</p>
<ol>
<li style="color:#D0D0D0;font-size:2.5vh;line-height:150%" node="[object Object]">dockerfile 작성</li>
<li style="color:#D0D0D0;font-size:2.5vh;line-height:150%" node="[object Object]">oracle vm instance 생성 및 접속</li>
<li style="color:#D0D0D0;font-size:2.5vh;line-height:150%" node="[object Object]">생성된 vm instance에서 docker image build 및 run</li>
</ol>
<h2 style="color:white" node="[object Object]">dockerfile 작성</h2>
<p style="color:#D0D0D0;font-size:2.5vh;line-height:160%" node="[object Object]">경우에 따라 oracle cloud의 vm instance를 초기화하거나 만에하나 다른 서비스를 이용하게 될지도 모른다. 그게 아니더라도 oracle vm에서 현재 local과 완전히 동일한 서버 설정을 할 수 있을 확률은 매우 희박하다고 생각한다. 따라서 docker을 이용해 개발중인 서버를 containerize한 상태로 배포하는 것이 편할 것이라고 생각했다. 현재 프로젝트가 <code style="color:darkcyan">poetry</code>를 이용해 depedency를 관리하므로 가상환경 설정 또한 poetry install을 통해 쉽게 가능하다. 완성한 <code style="color:darkcyan">Dockerfile</code>과 <code style="color:darkcyan">.dockerignore</code>는 아래와 같다. <code style="color:darkcyan">git clone</code>으로 repository를 복사하고 <code style="color:darkcyan">docker build</code>를 실행하면 /usr/src/app 경로에 필요한 파일을 복사하고 poetry가 venv를 생성, 서버(app.py)가 해당 환경에서 실행된다.</p>
<pre><div style="color:#a9b7c6;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;background:#2b2b2b"><code class="language-Dockerfile" style="color:#a9b7c6;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span># Dockerfile
</span>FROM python:3.11
<!-- -->
<!-- -->WORKDIR &quot;/usr/src/app&quot;
<!-- -->
<!-- -->RUN pip install poetry
<!-- -->
<!-- -->COPY pyproject.toml poetry.lock ./
<!-- -->
<!-- -->RUN poetry install
<!-- -->
<!-- -->COPY ./ ./
<!-- -->
<!-- -->ENTRYPOINT [&quot;poetry&quot;, &quot;run&quot;, &quot;python&quot;, &quot;app.py&quot;]</code></div></pre>
<pre><div style="color:#a9b7c6;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;background:#2b2b2b"><code class="language-Dockerfile" style="color:#a9b7c6;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span># .dockerignore
</span>__pycache__
<!-- -->.venv
<!-- -->.git
<!-- -->.gitignore
<!-- -->Dockerfile
<!-- -->.dockerignore
<!-- -->*.md</code></div></pre>
<p style="color:#D0D0D0;font-size:2.5vh;line-height:160%" node="[object Object]">아래 두 명령으로 image를 빌드하고 실행해보면 잘 작동하는 것을 확인할 수 있다.</p>
<pre><div style="color:#a9b7c6;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;background:#2b2b2b"><code class="language-cmd" style="color:#a9b7c6;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span>docker build -f Dockerfile -t tadak-docker .
</span>docker run -p 5000:5000 tadak-docker</code></div></pre>
<center>
<img src="https://raw.githubusercontent.com/bill0077/my-blog/gh-pages/post-contents/tadak-dev-log/media/docker-working.png" width="100%" title="docker-working"/>
</center>
<h2 style="color:white" node="[object Object]">oracle cloud 인스턴스 생성 및 접속</h2>
<p style="color:#D0D0D0;font-size:2.5vh;line-height:160%" node="[object Object]">이제 만들어진 container를 호스팅할 vm instance를 만들어 보자. 먼저 oracle cloud에서 회원가입하고 oracle mobile authenticator 앱도 다운받아 준다.authenticator를 이용해 oracle cloud에 접속하면 free tier vm을 무료로 생성할 수 있다.</p>
<p style="color:#D0D0D0;font-size:2.5vh;line-height:160%" node="[object Object]">하단에 <code style="color:darkcyan">Create a VM instance</code>를 클릭해 vm instance를 생성해보자. 이때 <code style="color:darkcyan">Image and Shape</code> 항목에서 기본 설정인 oracle linux가 아닌 ubuntu로 변경하는 것을 추천한다. 기본 설정인 oracle linux의 경우 <code style="color:darkcyan">apt-get</code> 명령이 존재하지 않는 등 몇번의 시행착오 끝에 속 편하게 그냥 <code style="color:darkcyan">ubuntu</code>로 설정하였다. 또한 <code style="color:darkcyan">Add SSH keys</code>에서도 Save private key로 private key를 다운받거나 public key를 등록해주어야 나주에 ssh로 접속해서 원활히 사용이 가능하다. <p style="color:white;display:inline;font-weight:bold" node="[object Object]">SSH 키의 경우 지금 화면에서밖에 설정할 수 없으니 조심하자!</p></p>
<p style="color:#D0D0D0;font-size:2.5vh;line-height:160%" node="[object Object]">이후로 생성을 완료하면 Dashboard에서 나의 instance 목록을 확인할 수 있다. 생성된 instance를 클릭하면 IP주소나 user 이름(기본은 ubuntu) 등을 확인할 수 있다.</p>
<p style="color:#D0D0D0;font-size:2.5vh;line-height:160%" node="[object Object]">이제 생성한 instance에 SSH를 이용해 접속해보자. 나는 vscode에서 작업하기 위해 vscode의 <code style="color:darkcyan">SSH FS</code>라는 extension을 이용해 접속하였다. 사용하는 방법은 간단하다.</p>
<ol>
<li style="color:#D0D0D0;font-size:2.5vh;line-height:150%" node="[object Object]">vscode의 Extensions에서 SSH FS를 추가하고</li>
<li style="color:#D0D0D0;font-size:2.5vh;line-height:150%" node="[object Object]">SSH FS의 <code style="color:darkcyan">Configurations</code>에서 <code style="color:darkcyan">Create a SSH FS Configuration</code> 클릭</li>
<li style="color:#D0D0D0;font-size:2.5vh;line-height:150%" node="[object Object]">이름을 간단히 설정해주고 Host와 Port 부분에서 Oracle vm instace의 IP와 port(보통은 22)를 입력</li>
<li style="color:#D0D0D0;font-size:2.5vh;line-height:150%" node="[object Object]"><code style="color:darkcyan">Private key</code>에서 다운받은 SSH key의 경로 입력</li>
</ol>
<p style="color:#D0D0D0;font-size:2.5vh;line-height:160%" node="[object Object]">이후 <code style="color:darkcyan">Open remote SSH terminal</code>을 통해 oracle vm instace에 접속 가능하다. 접속이 되었다면 유저 비밀번호 설정등 보안에 신경써주자.</p>
<h1 style="color:white;border-bottom:solid" node="[object Object]">생성된 vm instance에서 docker image build 및 run</h1>
<p style="color:#D0D0D0;font-size:2.5vh;line-height:160%" node="[object Object]">vm에 접속해서 서버를 직접 실행해보자. 먼저 <code style="color:darkcyan">git clone</code>으로 서버파일, dockerfile 등이 포함된 repository를 받아왔다. 이후 위에서처럼 <code style="color:darkcyan">docker build -f Dockerfile -t tadak-docker .</code> 명령을 실행해보면 <code style="color:darkcyan">docker</code>가 없다고 나온다. 먼저 docker부터 깔아주자 (git은 ubuntu vm의 경우 기본 설치되어있다). docker docs에서 제시하는 방법 그대로 따라가면 된다.</p>
<p style="color:#D0D0D0;font-size:2.5vh;line-height:160%" node="[object Object]">먼저 docker의 apt repository를 설정해주자.</p>
<pre><div style="color:#a9b7c6;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;background:#2b2b2b"><code class="language-bash" style="color:#a9b7c6;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token" style="color:#808080"># Add Docker&#x27;s official GPG key:</span><span>
</span><span></span><span class="token" style="color:#ffc66d">sudo</span><span> </span><span class="token" style="color:#ffc66d">apt-get</span><span> update
</span><span></span><span class="token" style="color:#ffc66d">sudo</span><span> </span><span class="token" style="color:#ffc66d">apt-get</span><span> </span><span class="token" style="color:#ffc66d">install</span><span> ca-certificates </span><span class="token" style="color:#ffc66d">curl</span><span>
</span><span></span><span class="token" style="color:#ffc66d">sudo</span><span> </span><span class="token" style="color:#ffc66d">install</span><span> -m 0755 -d /etc/apt/keyrings
</span><span></span><span class="token" style="color:#ffc66d">sudo</span><span> </span><span class="token" style="color:#ffc66d">curl</span><span> -fsSL https://download.docker.com/linux/ubuntu/gpg -o /etc/apt/keyrings/docker.asc
</span><span></span><span class="token" style="color:#ffc66d">sudo</span><span> </span><span class="token" style="color:#ffc66d">chmod</span><span> a+r /etc/apt/keyrings/docker.asc
</span>
<span></span><span class="token" style="color:#808080"># Add the repository to Apt sources:</span><span>
</span><span></span><span class="token class-name" style="color:#e8bf6a">echo</span><span> </span><span class="token" style="color:#a9b7c6">\</span><span>
</span><span>  </span><span class="token" style="color:#6a8759">&quot;deb [arch=</span><span class="token" style="color:#9876aa">$(</span><span class="token" style="color:#9876aa">dpkg --print-architecture</span><span class="token" style="color:#9876aa">)</span><span class="token" style="color:#6a8759"> signed-by=/etc/apt/keyrings/docker.asc] https://download.docker.com/linux/ubuntu \
</span><span class="token" style="color:#6a8759">  </span><span class="token" style="color:#9876aa">$(</span><span class="token class-name" style="color:#e8bf6a">.</span><span class="token" style="color:#9876aa"> /etc/os-release </span><span class="token" style="color:#a9b7c6">&amp;&amp;</span><span class="token" style="color:#9876aa"> </span><span class="token class-name" style="color:#e8bf6a">echo</span><span class="token" style="color:#9876aa"> </span><span class="token" style="color:#9876aa">&quot;</span><span class="token" style="color:#9876aa">$VERSION_CODENAME</span><span class="token" style="color:#9876aa">&quot;</span><span class="token" style="color:#9876aa">)</span><span class="token" style="color:#6a8759"> stable&quot;</span><span> </span><span class="token" style="color:#a9b7c6">|</span><span> </span><span class="token" style="color:#a9b7c6">\</span><span>
</span><span>  </span><span class="token" style="color:#ffc66d">sudo</span><span> </span><span class="token" style="color:#ffc66d">tee</span><span> /etc/apt/sources.list.d/docker.list </span><span class="token" style="color:#a9b7c6">&gt;</span><span> /dev/null
</span><span></span><span class="token" style="color:#ffc66d">sudo</span><span> </span><span class="token" style="color:#ffc66d">apt-get</span><span> update</span></code></div></pre>
<p style="color:#D0D0D0;font-size:2.5vh;line-height:160%" node="[object Object]">이후 apt-get을 이용해 최신 버전의 docker을 설치해준다.</p>
<pre><code style="color:darkcyan">sudo apt-get install docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin
</code></pre>
<p style="color:#D0D0D0;font-size:2.5vh;line-height:160%" node="[object Object]">설치가 끝나면 아래 명령을 실행해봄으로써 설치가 잘 진행되었는지 확인할 수 있다. 설치가 잘 되었다면 해당 명령을 실행했을 때 image pull등의 작업 이후 hello-world가 출력된다.</p>
<pre><div style="color:#a9b7c6;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;background:#2b2b2b"><code class="language-bash" style="color:#a9b7c6;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token" style="color:#ffc66d">sudo</span><span> </span><span class="token" style="color:#ffc66d">docker</span><span> run hello-world</span></code></div></pre>
<p style="color:#D0D0D0;font-size:2.5vh;line-height:160%" node="[object Object]">docker 설치 이후 다시 image build 명령을 해도 <code style="color:darkcyan">ERROR: permission denied while trying to connect to the Docker daemon socket at...</code>처럼 권한이 없다며 실행되지 않는다. 단순히 sudo를 사용해도 되지만 docker를 매번 root 권한으로 실행하기는 번거로워보인다. docker docs에서 안내해주는대로 docker group에 user를 추가해보자. 다만 docker group이 user에게 root-level 권한을 준다는 것은 주의해야 한다.</p>
<div style="border-left:1vh cadetblue solid;background-color:#282828"><p style="margin-left:1vh;margin-right:1vh;color:#D0D0D0;font-size:2.5vh;line-height:150%" node="[object Object]">
<p style="color:#D0D0D0;font-size:2.5vh;line-height:160%" node="[object Object]">The docker group grants root-level privileges to the user.</p>
</p></div>
<pre><div style="color:#a9b7c6;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;background:#2b2b2b"><code class="language-bash" style="color:#a9b7c6;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token" style="color:#ffc66d">sudo</span><span> </span><span class="token" style="color:#ffc66d">groupadd</span><span> </span><span class="token" style="color:#ffc66d">docker</span><span>
</span><span></span><span class="token" style="color:#ffc66d">sudo</span><span> </span><span class="token" style="color:#ffc66d">usermod</span><span> -aG </span><span class="token" style="color:#ffc66d">docker</span><span> </span><span class="token environment" style="color:#9876aa">$USER</span><span>
</span><span>newgrp </span><span class="token" style="color:#ffc66d">docker</span></code></div></pre>
<p style="color:#D0D0D0;font-size:2.5vh;line-height:160%" node="[object Object]">이 과정에서 vm 재시작이 필요할 수도 있다. 이제 다시 sudo 권한없이 <code style="color:darkcyan">docker run hello-world</code> 명령을 실행해보면 잘 작동함을 알 수 있다. 이제 매 실행마다 sudo를 붙일 필요 없이 docker 명령 실행이 가능해진다. 이제 진짜로 image build및 실행을 해보자.</p>
<pre><div style="color:#a9b7c6;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;background:#2b2b2b"><code class="language-bash" style="color:#a9b7c6;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token" style="color:#ffc66d">docker</span><span> build -f Dockerfile -t tadak-docker </span><span class="token class-name" style="color:#e8bf6a">.</span><span>
</span><span></span><span class="token" style="color:#ffc66d">docker</span><span> run -p </span><span class="token" style="color:#6897bb">5000</span><span>:5000 tadak-docker</span></code></div></pre>
<p style="color:#D0D0D0;font-size:2.5vh;line-height:160%" node="[object Object]">여기까지 문제가 없다면 docer container 내부의 서버가 잘 실행되고 있음을 확인할 수 있을 것이다.</p>
<center>
<img src="https://raw.githubusercontent.com/bill0077/my-blog/gh-pages/post-contents/tadak-dev-log/media/docker-running.png" width="100%" title="docker-running"/>
</center>
<p style="color:#D0D0D0;font-size:2.5vh;line-height:160%" node="[object Object]">그런데 서버가 잘 실행되는것을 확인하고 해당 container을 실행하는 vm의 public ip와 port를 통해 접속을 하려 해도 접속이 되지 않는다. <code style="color:darkcyan">docker run</code> 명령에서 container의 port binding까지 해놓았는데, 무엇이 문제일까?</p>
<p style="color:#D0D0D0;font-size:2.5vh;line-height:160%" node="[object Object]">결론적으로 이는 방화벽 문제였다. docker에서 port binding을 통해 docker container내부와 host(이 경우엔 host는 vm의 ubuntu)간 통신은 가능하지만 vm 외부에서 접속하려는 시도를 firewall에서 막기 때문에 접속이 안되는 것이었다. oracle vm instance는 oracle cloud 방화벽과 ubuntu os자체의 방화벽 2개가 모두 적용되어 있다. 외부와의 통신을 위해 vm과 ubuntu os의 방화벽을 설정해주자.</p>
<p style="color:#D0D0D0;font-size:2.5vh;line-height:160%" node="[object Object]">oracle cloud의 방화벽 설정 방법은 여기에 나와 있다 (<a to="https://www.oracle.com/webfolder/technetwork/tutorials/obe/cloud/compute/permitting_public_tcp_traffic_to_compute_instances/permitting_public_tcp_traffic_to_compute_instances.html" style="color:cadetblue;display:inline" href="https://www.oracle.com/webfolder/technetwork/tutorials/obe/cloud/compute/permitting_public_tcp_traffic_to_compute_instances/permitting_public_tcp_traffic_to_compute_instances.html" node="[object Object]">https://www.oracle.com/webfolder/technetwork/tutorials/obe/cloud/compute/permitting_public_tcp_traffic_to_compute_instances/permitting_public_tcp_traffic_to_compute_instances.html</a>). 자세한 설명은 이 2곳에서 찾아보면 좋을것 같다 (<a to="https://kibua20.tistory.com/124" style="color:cadetblue;display:inline" href="https://kibua20.tistory.com/124" node="[object Object]">https://kibua20.tistory.com/124</a>, <a to="https://pivox.tistory.com/47" style="color:cadetblue;display:inline" href="https://pivox.tistory.com/47" node="[object Object]">https://pivox.tistory.com/47</a>). 위 블로그에서 찾은 방법대로 방화벽을 설정하고 나면 이전에는 외부요청에 묵묵부답이던 서버가 요청에 잘 응답함을 확인할 수 있다.</p>
<center>
<img src="https://raw.githubusercontent.com/bill0077/my-blog/gh-pages/post-contents/tadak-dev-log/media/after-firewall-setting.png" width="100%" title="after-firewall-setting"/>
</center>
<p style="color:#D0D0D0;font-size:2.5vh;line-height:160%" node="[object Object]"><p style="color:white;display:inline;font-weight:bold" node="[object Object]">다만!</p> 지금 서버에서 외부 접속이 잘 되는 것은 frontend를 local development server에서 실행했기 때문이다. 만일 현재까지 개발된 frontend를 github pages와 같은곳에 호스팅하고 배포해보면 서버에 접속하지 못한다. 이는 현재 backend 코드는 ssl을 일체 사용하지 않는 반면, github pages에서는 https를 지원하기 때문이다. 따라서 현상태에서는 https frontend가 http 요청을 서버에 하게 되는데, 이때 브라우저 단에서 Mixed content 에러가 발생하며 서버 접속에 실패한다. 이를 위해서는 backend ssl 설정이 필요하다. 이건 다음 글에서 다뤄보겠다.</p>
<h1 style="color:white;border-bottom:solid" node="[object Object]">reference</h1>
<p style="color:#D0D0D0;font-size:2.5vh;line-height:160%" node="[object Object]">docker docs, Install using the apt repository: <a to="https://docs.docker.com/engine/install/ubuntu/" style="color:cadetblue;display:inline" href="https://docs.docker.com/engine/install/ubuntu/" node="[object Object]">https://docs.docker.com/engine/install/ubuntu/</a></p>
<p style="color:#D0D0D0;font-size:2.5vh;line-height:160%" node="[object Object]">docker docs, Manage Docker as a non-root user: <a to="https://docs.docker.com/engine/install/linux-postinstall/#manage-docker-as-a-non-root-user" style="color:cadetblue;display:inline" href="https://docs.docker.com/engine/install/linux-postinstall/#manage-docker-as-a-non-root-user" node="[object Object]">https://docs.docker.com/engine/install/linux-postinstall/#manage-docker-as-a-non-root-user</a></p></div></div></div></div><div id="gatsby-announcer" style="position:absolute;top:0;width:1px;height:1px;padding:0;overflow:hidden;clip:rect(0, 0, 0, 0);white-space:nowrap;border:0" aria-live="assertive" aria-atomic="true"></div></div><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/tadak-dev-log/deploy-with-oraclecloud/";/*]]>*/</script><!-- slice-start id="_gatsby-scripts-1" -->
          <script
            id="gatsby-chunk-mapping"
          >
            window.___chunkMapping="{\"app\":[\"/app-4dcf80b3ec3c1d7e90c0.js\"],\"component---src-pages-index-js\":[\"/component---src-pages-index-js-4ec131227afe6d26b02a.js\"],\"component---src-pages-toy-projects-solar-system-js\":[\"/component---src-pages-toy-projects-solar-system-js-26c2bfa09265e4bde8c7.js\"],\"component---src-templates-post-js\":[\"/component---src-templates-post-js-1e0638dc97f9811b5b4b.js\"],\"component---src-templates-post-list-js\":[\"/component---src-templates-post-list-js-7f0c417f55c0bb11f326.js\"]}";
          </script>
        <script>window.___webpackCompilationHash="bf84e23dddaa824c8654";</script><script src="/my-blog/webpack-runtime-78e8db40ba63a1f896dc.js" async></script><script src="/my-blog/framework-421aea1a5abe8c38ff0e.js" async></script><script src="/my-blog/app-4dcf80b3ec3c1d7e90c0.js" async></script><!-- slice-end id="_gatsby-scripts-1" --></body></html>